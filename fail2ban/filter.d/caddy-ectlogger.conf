# Fail2Ban filter for Caddy serving ECTLogger
# 
# This filter matches malicious requests logged by Caddy's access log.
# Catches scanners, exploit attempts, and suspicious activity.
#
# Caddy JSON log format (default):
#   {"level":"info","ts":1234567890.123,"logger":"http.log.access","msg":"handled request",
#    "request":{"remote_ip":"1.2.3.4","method":"GET","uri":"/path",...},"status":404,...}

[INCLUDES]
before = common.conf

[Definition]

# Match common attack patterns in Caddy JSON logs
# Each pattern looks for remote_ip followed by suspicious URIs or behaviors

# WordPress/CMS scanners
failregex = ^.*"remote_ip":"<HOST>".*"uri":".*(?:wp-admin|wp-login|wp-content|wp-includes|wordpress|xmlrpc\.php).*".*$

# PHPMyAdmin/database admin scanners
            ^.*"remote_ip":"<HOST>".*"uri":".*(?:phpmyadmin|pma|myadmin|mysql|adminer|dbadmin).*".*$

# Config/sensitive file probes
            ^.*"remote_ip":"<HOST>".*"uri":".*(?:\.env|\.git|\.svn|\.htaccess|\.htpasswd|config\.php|wp-config|settings\.php).*".*$

# Shell/backdoor attempts
            ^.*"remote_ip":"<HOST>".*"uri":".*(?:shell|c99|r57|cmd|eval|exec|system|passthru).*".*$

# Path traversal attempts
            ^.*"remote_ip":"<HOST>".*"uri":".*(?:\.\./|\.\.\\|%2e%2e|%252e).*".*$

# SQL injection attempts
            ^.*"remote_ip":"<HOST>".*"uri":".*(?:union.*select|select.*from|insert.*into|drop.*table|;.*--|1=1|or.*1.*=.*1).*".*$

# Common vulnerability scanners
            ^.*"remote_ip":"<HOST>".*"uri":".*(?:cgi-bin|\.cgi|\.pl|\.asp|\.aspx|\.jsp).*".*$

# Specific exploit paths
            ^.*"remote_ip":"<HOST>".*"uri":".*(?:/manager/|/admin/|/console/|/jmx-console|/invoker/).*".*$

# Repeated 404s on non-existent paths (aggressive scanning)
# Uncomment if you want to ban after multiple 404s
#            ^.*"remote_ip":"<HOST>".*"status":404.*$

# Ignored patterns - don't ban for these
ignoreregex = ^.*"remote_ip":"<HOST>".*"uri":"/api/.*".*"status":401.*$
              ^.*"remote_ip":"<HOST>".*"uri":"/favicon\.ico".*$
              ^.*"remote_ip":"<HOST>".*"uri":"/robots\.txt".*$

# Caddy uses Unix timestamps in JSON logs
datepattern = "ts":\s*{EPOCH}

[Init]
# DEV Notes:
# 
# Caddy must be configured to log in JSON format to a file.
# Add to Caddyfile:
#   (logging) {
#       log {
#           output file /var/log/caddy/access.log
#           format json
#       }
#   }
#
# To test the filter:
#   fail2ban-regex /var/log/caddy/access.log /etc/fail2ban/filter.d/caddy-ectlogger.conf
#
# Author: ECTLogger Team
