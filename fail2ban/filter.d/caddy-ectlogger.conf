# Fail2Ban filter for Caddy serving ECTLogger
# 
# This filter matches malicious requests logged by Caddy's access log.
# Catches scanners, exploit attempts, and suspicious activity.
#
# Caddy JSON log format (default):
#   {"level":"info","ts":1234567890.123,"logger":"http.log.access","msg":"handled request",
#    "request":{"remote_ip":"1.2.3.4","method":"GET","uri":"/path",...},"status":404,...}
#
# IMPORTANT: Patterns use [^"]* to match ONLY within the uri field value,
# stopping at the closing quote. This prevents false matches on headers.

[INCLUDES]
before = common.conf

[Definition]

# Match common attack patterns in Caddy JSON logs
# Using [^"]* to match only within the uri field value (stops at closing quote)

# WordPress/CMS scanners
failregex = ^.*"remote_ip":"<HOST>".*"uri":"[^"]*(?:wp-admin|wp-login|wp-content|wp-includes|wordpress|xmlrpc\.php)[^"]*".*$

# PHPMyAdmin/database admin scanners
            ^.*"remote_ip":"<HOST>".*"uri":"[^"]*(?:phpmyadmin|pma|myadmin|mysql|adminer|dbadmin)[^"]*".*$

# Config/sensitive file probes
            ^.*"remote_ip":"<HOST>".*"uri":"[^"]*(?:\.env|\.git|\.svn|\.htaccess|\.htpasswd|config\.php|wp-config|settings\.php)[^"]*".*$

# Shell/backdoor attempts (match as path components)
            ^.*"remote_ip":"<HOST>".*"uri":"[^"]*(?:/shell|/c99|/r57|/cmd\.php|/eval\.|/exec\.)[^"]*".*$

# Path traversal attempts (%% escapes % in fail2ban configs)
            ^.*"remote_ip":"<HOST>".*"uri":"[^"]*(?:\.\./|\.\.\\|%%2e%%2e|%%252e)[^"]*".*$

# SQL injection - specific URL-encoded patterns only
            ^.*"remote_ip":"<HOST>".*"uri":"[^"]*(?:union%%20select|union\+select|select%%20from|select\+from|%%27--|%%22--)[^"]*".*$

# Legacy script paths (CGI, ASP, etc.)
            ^.*"remote_ip":"<HOST>".*"uri":"[^"]*(?:/cgi-bin/|\.cgi\?|\.pl\?|\.asp$|\.aspx$|\.jsp$)[^"]*".*$

# Application manager consoles
            ^.*"remote_ip":"<HOST>".*"uri":"[^"]*(?:/manager/html|/jmx-console|/invoker/|/web-console)[^"]*".*$

# Ignored patterns - don't ban for these
ignoreregex = ^.*"remote_ip":"<HOST>".*"uri":"/api/[^"]*".*"status":401.*$
              ^.*"remote_ip":"<HOST>".*"uri":"/favicon\.ico".*$
              ^.*"remote_ip":"<HOST>".*"uri":"/robots\.txt".*$

# Caddy uses Unix timestamps in JSON logs
datepattern = "ts":\s*{EPOCH}

[Init]
# DEV Notes:
# 
# Caddy must be configured to log in JSON format to a file.
# Add to Caddyfile:
#   (logging) {
#       log {
#           output file /var/log/caddy/access.log
#           format json
#       }
#   }
#
# To test the filter:
#   fail2ban-regex /var/log/caddy/access.log /etc/fail2ban/filter.d/caddy-ectlogger.conf
#
# Author: ECTLogger Team
